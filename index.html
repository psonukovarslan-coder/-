<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Код-редактор в TG</title>

    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/eclipse.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/rust/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/shell/shell.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/dialog/dialog.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/dialog/dialog.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closebrackets.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #ddd; height: 100vh; display: flex; flex-direction: column; }
        .toolbar { background: #252526; padding: 8px; border-bottom: 1px solid #3c3c3c; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; z-index: 10; }
        .toolbar button, .toolbar select { background: #3c3c3c; color: #ccc; border: none; padding: 6px 10px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        .toolbar button:hover, .toolbar select:hover { background: #4c4c4c; }
        .toolbar .separator { width: 1px; background: #555; margin: 0 8px; }
        .CodeMirror { flex: 1; height: auto !important; }
        .statusbar { background: #007acc; color: white; padding: 4px 10px; font-size: 12px; display: flex; justify-content: space-between; }
        .theme-light .toolbar { background: #f3f3f3; }
        .theme-light .toolbar button, .theme-light .toolbar select { background: #e0e0e0; color: #333; }
        .theme-light { background: #ffffff; color: #333; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button id="newFile">Новый</button>
        <button id="saveBtn">Сохранить</button>
        <button id="copyBtn">Копировать</button>
        <button id="downloadBtn">Скачать</button>
        <div class="separator"></div>
        <select id="langSelect">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="htmlmixed">HTML</option>
            <option value="css">CSS</option>
            <option value="java">Java</option>
            <option value="cpp">C++</option>
            <option value="csharp">C#</option>
            <option value="php">PHP</option>
            <option value="sql">SQL</option>
            <option value="go">Go</option>
            <option value="rust">Rust</option>
            <option value="shell">Shell</option>
            <option value="xml">XML</option>
        </select>
        <select id="themeSelect">
            <option value="dracula">Dracula</option>
            <option value="monokai">Monokai</option>
            <option value="eclipse">Eclipse (светлая)</option>
        </select>
        <div class="separator"></div>
        <button id="searchBtn">Поиск (Ctrl+F)</button>
        <button id="undoBtn">Отмена</button>
        <button id="redoBtn">Повтор</button>
    </div>

    <textarea id="codeEditor"></textarea>

    <div class="statusbar">
        <span id="statusLang">Язык: JavaScript</span>
        <span id="statusLines">Строк: 0</span>
        <span id="statusChars">Симв.: 0</span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            lineNumbers: true,
            mode: "javascript",
            theme: "dracula",
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            autoCloseBrackets: true,
            matchBrackets: true,
            lineWrapping: false,
            extraKeys: {
                "Ctrl-F": "findPersistent",
                "Ctrl-S": () => saveCode(),
                "Ctrl-Z": () => editor.undo(),
                "Ctrl-Y": () => editor.redo()
            }
        });

        const langMap = {
            javascript: { name: "JavaScript", mode: "javascript" },
            python: { name: "Python", mode: "python" },
            htmlmixed: { name: "HTML", mode: "htmlmixed" },
            css: { name: "CSS", mode: "css" },
            java: { name: "Java", mode: "text/x-java" },
            cpp: { name: "C++", mode: "text/x-c++src" },
            csharp: { name: "C#", mode: "text/x-csharp" },
            php: { name: "PHP", mode: "application/x-httpd-php" },
            sql: { name: "SQL", mode: "text/x-sql" },
            go: { name: "Go", mode: "text/x-go" },
            rust: { name: "Rust", mode: "text/x-rustsrc" },
            shell: { name: "Shell", mode: "text/x-sh" },
            xml: { name: "XML", mode: "application/xml" }
        };

        const langSelect = document.getElementById("langSelect");
        const themeSelect = document.getElementById("themeSelect");
        const statusLang = document.getElementById("statusLang");
        const statusLines = document.getElementById("statusLines");
        const statusChars = document.getElementById("statusChars");

        function updateStatus() {
            const lines = editor.lineCount();
            const chars = editor.getValue().length;
            const lang = langSelect.value;
            statusLang.textContent = `Язык: ${langMap[lang].name}`;
            statusLines.textContent = `Строк: ${lines}`;
            statusChars.textContent = `Симв.: ${chars}`;
        }
        editor.on("change", updateStatus);

        langSelect.addEventListener("change", () => {
            const mode = langMap[langSelect.value].mode;
            editor.setOption("mode", mode);
            updateStatus();
        });

        themeSelect.addEventListener("change", () => {
            const theme = themeSelect.value;
            editor.setOption("theme", theme);
            document.body.className = theme === "eclipse" ? "theme-light" : "";
        });

        document.getElementById("newFile").addEventListener("click", () => {
            if (confirm("Создать новый файл?")) editor.setValue("");
        });

        document.getElementById("copyBtn").addEventListener("click", () => {
            navigator.clipboard.writeText(editor.getValue()).then(() => tg.showAlert("Скопировано!"));
        });

        document.getElementById("downloadBtn").addEventListener("click", () => {
            const blob = new Blob([editor.getValue()], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `code.${getFileExtension()}`;
            a.click();
            URL.revokeObjectURL(url);
        });

        function getFileExtension() {
            const exts = { javascript: "js", python: "py", htmlmixed: "html", css: "css", java: "java", cpp: "cpp", csharp: "cs", php: "php", sql: "sql", go: "go", rust: "rs", shell: "sh", xml: "xml" };
            return exts[langSelect.value] || "txt";
        }

        function saveCode() {
            const data = { code: editor.getValue(), language: langSelect.value, filename: `code.${getFileExtension()}` };
            tg.sendData(JSON.stringify(data));
            tg.close();
        }
        document.getElementById("saveBtn").addEventListener("click", saveCode);

        document.getElementById("undoBtn").addEventListener("click", () => editor.undo());
        document.getElementById("redoBtn").addEventListener("click", () => editor.redo());
        document.getElementById("searchBtn").addEventListener("click", () => CodeMirror.commands.findPersistent(editor));

        // === ОБРАБОТКА start_param ===
        document.addEventListener("DOMContentLoaded", () => {
            const initData = tg.initDataUnsafe;
            if (initData && initData.start_param) {
                try {
                    const decoded = decodeURIComponent(initData.start_param);
                    const param = JSON.parse(decoded);
                    if (param.code) editor.setValue(param.code);
                    if (param.lang && langMap[param.lang]) {
                        langSelect.value = param.lang;
                        editor.setOption("mode", langMap[param.lang].mode);
                    }
                    updateStatus();
                } catch (e) {
                    console.error("Ошибка start_param:", e);
                }
            }
        });

        updateStatus();
    </script>
</body>
</html>
